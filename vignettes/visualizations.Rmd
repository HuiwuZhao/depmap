---
title: "visualizations"
author: "Theo Killian"
date: "March 26, 2019"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{depmap vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r, include = FALSE, echo = FALSE, results = 'asis'}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# [depmap](https://github.com/tfkillian/depmap/) visualizations

This vignette illustrates visualizations of the data found in the 
[depmap](https://github.com/tfkillian/depmap/) package after the data has been
loaded (see depmap.Rmd vignette). NOTE: (!!!) this vignette assumes that you 
have already ran the depmap.Rmd vignette and uploaded all the depmap datasets. 

## Introduction {#sec:intro}

The [depmap](https://github.com/tfkillian/depmap/) package aims to provide a 
reproducible research framework to cancer dependency data described by 
[Tsherniak, Aviad, et al. "Defining a cancer dependency map." Cell 170.3 (2017):
564-576.](https://www.ncbi.nlm.nih.gov/pubmed/28753430). The data found in the
[depmap](https://github.com/tfkillian/depmap/) package has been formatted to 
facilitate the use of common R packages such as `dplyr` and `ggplot2`. We hope 
that this package will allow researchers to more easily mine, explore and 
visually illustrate dependency data taken from the Depmap cancer genomic 
dependency study.

## Visualisations

Perhaps the most interesting datasets found within the 
[depmap](https://github.com/tfkillian/depmap/) package are those that relate to 
the cancer gene dependency score, such as `rnai` and `crispr`. These datasets 
contain a score expressing how vital a particular gene is in terms of how lethal
the knockout/knockdown of that gene is on a target cell line. For example, a 
highly negative dependency score implies that a cell line is highly dependent 
on that gene. 

We will demonstrate how to obtain individual dependency scores corresponding to 
a specific gene and cell lineage. For example, shown below is the dependency of 
a breast cancer lineage, such as `184A1_BREAST` has on a human tumor suppressor 
gene, like `BRCA1` when it is knocked down via RNAi. Shown below is the 
comparison for data found within the `rnai` dataset. This shows a score which is
slightly positive, indicating that the knockdown of this gene is slightly 
beneficial to the vitality of this cancer cell lineage. However, it may be 
insightful to put this single dependency score in context. 

```{r, find_BRCA1_184A1_Breast_Dep_Score, echo=TRUE}
# load necessary libraries
library("dplyr")
library("plotly")
library("ggplot2") 
library("viridis")
library("tibble")
library("gridExtra") 

#find dependency score for "BRCA1"" on "184A1_Breast""
dep_Score_BRCA1_184A1Breast <- rnai %>% 
    select(cell_Line, gene_Name, dependency) %>%
    filter(cell_Line =="184A1_BREAST", gene_Name == "BRCA1") 
dep_Score_BRCA1_184A1Breast
```

Shown below is the average dependency score for `BRCA1` for all cancer cell 
lines in the `rnai` dataset.

```{r, find_BRCA1_Avg_Dep_Score, echo=TRUE}
#avg gene dependency for "BRCA1"
brca1_DS_Avg_RNAI <- rnai %>% select(gene_Name, dependency) %>%
    filter(gene_Name == "BRCA1") %>%
  summarise(mean_dependency_brca1 = mean(dependency, na.rm = TRUE))
brca1_DS_Avg_RNAI
```

Or to see the average gene dependency across all genes in the entire `rnai` 
dataset. As one can see below, the average dependency for an average gene in the
`rnai` dataset is slightly negative but close to zero.

```{r, avg_Gene_Dep_RNAI, echo=TRUE}
#avg gene dependency for all genes in `rnai` dataset
all_Gene_DS_Avg_RNAI <- rnai %>% select(gene_Name, dependency) %>%
  summarise(mean_dependency_all_genes_rnai = mean(dependency, na.rm = TRUE))
all_Gene_DS_Avg_RNAI
```

Sometimes it is difficult to find the subset with the exact gene name one wishes
to find. In this case, it is better to search by `entrez_ID`. For example, a 
[recent paper](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6251792/) describes
gene knockdown of *NRF2* increases chemosensitivity in certain types of cancer. 
It might be interesting to see what interactions knockdown of this gene has on
other cancer cell lines. However, searching by *filter(gene_Name == "NRF2")* 
will not yield any results. We know from NCBI that the Entrez ID for this gene 
is "4780" and it is possible to search this dataset by that criteria. Here it 
can be shown that the gene name for *NRF2* in the `rnai` dataset is *NFE2L2*.

```{r, find_cell_lines_with_entrz_ID_4780, echo=TRUE}
#find cell lines with dependency corresponding to "entrez_ID == "4780"
ent_ID_NRF2 <- rnai %>% select(entrez_ID, cell_Line, gene_Name, dependency) %>%
    filter(entrez_ID == "4780") 
ent_ID_NRF2
```

Below the highest dependency scores via RNAI knock down of a specific gene, 
*NFE2L2* will be obtained and the cancer cell lines associated with those values
will be listed. It appears that the knockdown of this gene is strongly 
associated with cell death with in lung and kidney cancer cell lines.

```{r, find_greatest_Dep_Score_NFE2L2, echo=TRUE}
#find cell lines with dependency for "NFE2L2" and select greatest dep scores
top_DS_NFE2L2_RNAI <- rnai %>% select(cell_Line, gene_Name, dependency) %>%
    filter(gene_Name == "NFE2L2") %>% arrange(dependency)
top_DS_NFE2L2_RNAI 
```

If we would like to obtain the top 10 lowest dependency scores for a 
particular cell line (for example `NCIH2066_LUNG`) along with the genes 
associated with those values:

```{r, find_Genes_Dep_Score_for_cell_line_NCIH2066_LUNG, echo=TRUE}
#find genes with dep for cell_Line == "NCIH2066_LUNG", sort by ascending
top_DS_NCIH2066_LUNG_RNAI <- rnai %>% 
    select(cell_Line, gene_Name, dependency) %>%
    filter(cell_Line == "NCIH2066_LUNG") %>% arrange(dependency)
top_DS_NCIH2066_LUNG_RNAI
```

Below shows the most significant genes that deplete cancer cell lines upon 
knockdown and their dependency scores for the entire `rnai` data.

```{r, find_cell_line_gene_rnai_greatest_dep_score, echo=TRUE}
# select `rnai` columns cell_Line, gene_Name, dependency with greatest dep score
greatest_DS_Gene_RNAI <- rnai %>% select(cell_Line, gene_Name, dependency) %>% 
    arrange(dependency)
greatest_DS_Gene_RNAI
```

Below shows the least significant genes that induce cancer cell line vitality 
upon knockdown and their dependency scores for the entire `rnai` data. 
Unsurprisingly, we see high incidence of "TP53", a well known cancer driver.

```{r, find_cell_line_gene_rnai_lowest_dep_score, echo=TRUE}
# select `rnai` columns cell_Line, gene_Name, dependency with lowest dep score
lowest_DS_Gene_RNAI <- rnai %>% select(cell_Line, gene_Name, dependency) %>% 
    arrange(desc(dependency))
lowest_DS_Gene_RNAI
```

Below we will apply some of the same selections as shown in the above examples 
on the `crispr` gene knockout dataset and observe the difference between that 
dataset and `rnai`. First we will look at the most significant dependency scores
in the `crispr` dataset. As can be seen below, there is a different population
of significant genes with the highest dependency score.

```{r, find_cell_line_gene_crispr_greatest_dep_score, echo=TRUE}
# select `crispr` columns cell_Line, gene_Name, dependency with greatest dep sc
greatest_DS_Gene_CRISPR <- crispr %>% 
    select(cell_Line, gene_Name,dependency) %>% arrange(dependency)
greatest_DS_Gene_CRISPR
```

First we will look at the least significant (most cancer inducing) dependency 
scores in the `crispr` dataset.

```{r, find_cell_line_gene_crispr_lowest_dep_score, echo=TRUE}
# select `crispr` columns cell_Line, gene_Name, dependency, for lowest dep score
lowest_DS_Gene_CRISPR <- crispr %>% select(cell_Line, gene_Name, dependency) %>%
    arrange(desc(dependency))
lowest_DS_Gene_CRISPR
```

Here we will plot the difference in expression between the most signficant genes
found in the `crispr` and `rnai` datasets. 

```{r, comparison_RNAI_CRISPR_Dep_Scores, fig.height = 6, fig.width = 6, fig.align = "center", echo=FALSE}
#sort `crispr` dep scores by most cancer inducing
high_20_Vals_CRISPR <- crispr %>% select(gene_Name, dependency) %>% 
    arrange(desc(dependency)) %>% top_n(20)

#sort `crispr` dep scores by least cancer inducing
low_20_Vals_CRISPR <- crispr %>% select(gene_Name, dependency) %>% 
    arrange(dependency) %>% top_n(-20)

#sort `rnai` dep scores by most cancer inducing
high_20_Vals_RNAI <- rnai %>% select(gene_Name, dependency) %>% 
    arrange(desc(dependency)) %>% top_n(20)
high_20_Vals_RNAI[12,1] <-"GAS6-AS2" #shorten gene name so it fits on plot

#sort `rnai` dep scores by least cancer inducing
low_20_Vals_RNAI <- rnai %>% select(gene_Name, dependency) %>% 
    arrange(dependency) %>% top_n(-20)

# rnai highest dep scores
p1 <- ggplot(low_20_Vals_RNAI) + 
    aes(gene_Name, dependency, color = dependency) +
    geom_point() + scale_colour_viridis() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("High DS genes RNAI")

# crispr highest dep scores
p2 <- ggplot(low_20_Vals_CRISPR) + 
    aes(gene_Name, dependency, color = dependency) +
    geom_point() + scale_colour_viridis() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("High DS genes CRISPR ")

# rnai lowest dep scores
p3 <- ggplot(high_20_Vals_RNAI) + 
    aes(gene_Name, dependency, color = dependency) +
    geom_point() + scale_colour_viridis() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Low DS genes RNAI")

# crispr lowest dep scores
p4 <- ggplot(high_20_Vals_CRISPR) + 
    aes(gene_Name, dependency, color = dependency) +
    geom_point() + scale_colour_viridis() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Low DS genes CRISPR")

#plot as 1x2 grid
grid.arrange(p1, p2, p3, p4, nrow = 2, 
             top = "Most Extreme Dep Scores for CRISPR and RNAI")
```

Compare the count of top 50 unique genes for `crispr` and `rnai` datasets for 
the most cancer-vitality inducing genes.

```{r, count_Comparison_RNAI_CRISPR_Dep_Scores, fig.height = 6, fig.width = 6, fig.align = "center", echo=FALSE}
# get counts of top 50 genes in `crispr` that are most cancer-vitality inducing
unique_Least_DS_Gene_CRISPR <- crispr %>% select(gene_Name, dependency) %>%
    arrange(desc(dependency)) %>% top_n(50) %>% 
    count(gene_Name) %>% arrange(desc(n))
# TBC1D3 appears to be an extremely common for `crispr` and dominates top 100 
# most cancer-vitality-inducing genes.

# get counts of top 50 genes in `rnai` that are most cancer-vitality inducing
unique_Least_DS_Gene_RNAI <- rnai %>% select(gene_Name, dependency) %>%
    arrange(desc(dependency)) %>% top_n(50) %>% 
    count(gene_Name) %>% arrange(desc(n))
unique_Least_DS_Gene_RNAI [9,1] <-"GAS6-AS2" #shorten gene name to fit on plot
# Whereas for `rnai` UBBP4 and ACTG1P4 are most common. 

# get counts of top 50 genes in `crispr` with greatest dependency
unique_Most_DS_Gene_CRISPR <- crispr %>% select(gene_Name, dependency) %>%
    arrange(dependency) %>% top_n(-50) %>% 
    count(gene_Name) %>% arrange(desc(n))
# Most common gene for top 100 most dependent genes in `crispr` is RAN

# get counts of top 50 genes in `rnai` with greatest dependency
unique_Most_DS_Gene_RNAI <- rnai %>% select(gene_Name, dependency) %>%
    arrange(dependency) %>% top_n(-50) %>% 
    count(gene_Name) %>% arrange(desc(n))
# Most common genes for top 100 most dependent genes in `rnai` are RPL7, EIF3B 
# and RPL14. 

# rnai highest dep scores
p5 <-ggplot(unique_Most_DS_Gene_CRISPR, aes(x=gene_Name, y=n))+
  geom_bar(stat='identity', fill="steelblue2")+
  ylab("count")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Highest DS genes CRISPR")

p6 <-ggplot(unique_Most_DS_Gene_RNAI, aes(x=gene_Name, y=n))+
  geom_bar(stat='identity', fill="steelblue2")+
  ylab("count")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Highest DS genes RNAI")

p7 <-ggplot(unique_Least_DS_Gene_CRISPR, aes(x=gene_Name, y=n))+
  geom_bar(stat='identity', fill="steelblue2")+
  ylab("count")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Lowest DS genes CRISPR")

p8 <-ggplot(unique_Least_DS_Gene_RNAI, aes(x=gene_Name, y=n))+
  geom_bar(stat='identity', fill="steelblue2")+
  ylab("count")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Lowest DS genes RNAI")

#plot as 1x2 grid
grid.arrange(p5, p6, p7, p8, nrow = 2, 
             top = "Top 50 Genes with High and Low Dep Score for CRISPR and RNAI")
```

Mean log copy number and Mean log copy number for each gene

```{r, mean_LCN_Gene_CopyNum, fig.height = 4, fig.width = 5, fig.align = "center", echo=FALSE}
# mean log copy number for all genes
mean_LCN_Gene_CopyNum <- copyNumber %>% select(gene_Name, logCopyNumber) %>%
  summarise(mean_log_Copy_Num_All_Genes = mean(logCopyNumber, na.rm = TRUE))

val_mean_LCN_Gene_CopyNum <- as.numeric(mean_LCN_Gene_CopyNum[1,1])

# mean log copy number for each gene
each_LCN_Gene_CopyNum <-copyNumber %>% select(gene_Name, logCopyNumber) %>%
  group_by(gene_Name) %>% 
    summarise(mean_log_CN = mean(logCopyNumber, na.rm = TRUE))

# add an ID column
all_LCN_Gene_CopyNum <- 
    as.data.frame(na.omit(each_LCN_Gene_CopyNum$mean_log_CN))  %>% 
     tibble::rowid_to_column(., "ID")

# add col names
colnames(all_LCN_Gene_CopyNum, do.NULL = FALSE)
colnames(all_LCN_Gene_CopyNum) <- c("gene","logCopyNumber")

# plot of mean copy number for every gene 
p9 <- ggplot(all_LCN_Gene_CopyNum) + 
    aes(x=gene, y=logCopyNumber, color = logCopyNumber) +
    geom_point() +  scale_colour_viridis() +
    geom_hline(yintercept = val_mean_LCN_Gene_CopyNum, 
               linetype = "dashed", color = "red") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle("Mean log copy number change for every gene")
p9
```

Find genes with greatest mean log copy number

```{r, greatest_LCN_Gene_CopyNum, fig.height = 4, fig.width = 5, fig.align = "center", echo=FALSE}
# mean log copy number for each gene
greatest_LCN_Gene_CopyNum <-copyNumber %>% select(gene_Name, logCopyNumber) %>%
  group_by(gene_Name) %>% summarise(mean_long_CN = mean(logCopyNumber)) %>%
    arrange(desc(mean_long_CN)) %>% top_n(20)

p10 <-ggplot(greatest_LCN_Gene_CopyNum, aes(x=gene_Name, y=mean_long_CN)) +
  geom_bar(stat='identity', fill="steelblue2") + ylab("log Copy Number") + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ggtitle("Top 20 genes with largest log copy number")
p10
```
