---
title: "depmap vignette"
author: "Theo Killian"
date: "February 19, 2019"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{depmap vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r, include = FALSE, echo = FALSE, results = 'asis'}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# [depmap](https://github.com/tfkillian/depmap/)

This vignette illustrates the steps in loading and visualizing the data found in
the [depmap](https://github.com/tfkillian/depmap/) package.  

## Introduction {#sec:intro}

The [depmap](https://github.com/tfkillian/depmap/) package aims to provide a 
reproducible research framework to cancer dependency data described by 
[Tsherniak, Aviad, et al. "Defining a cancer dependency map." Cell 170.3 (2017):
564-576.](https://www.ncbi.nlm.nih.gov/pubmed/28753430). The data found in the
[depmap](https://github.com/tfkillian/depmap/) package has been formatted to 
facilitate the use of common visualization packages such as `ggplot2`. We hope 
that this package will allow researchers to more easily, mine explore and 
visually illustrate dependency data taken from the Depmap cancer genomic 
dependency study.

```{r, eval=FALSE, echo=TRUE, warning=FALSE}
# This code chunk makes sure that all the libraries used here are installed
packages <- c("knitr", "tidyr", "dplyr", "ggplot2", "plotly", "viridis", 
              "tidyverse", "grid", "gridExtra", "reshape2")
if ( length(missing_pkgs <- setdiff(packages, 
                                    rownames(installed.packages()))) > 0) {
  message("Installing missing package(s): ", 
          paste(missing_pkgs, collapse = ", "))
  install.packages(missing_pkgs)
}
```

## Preliminaries

To install [depmap](https://github.com/tfkillian/depmap/), the [BiocManager](https://cran.r-project.org/web/packages/BiocManager/index.html) 
Bioconductor Project Package Manager is required. If 
[BiocManager](https://cran.r-project.org/web/packages/BiocManager/index.html) is
not already installed, it will need to be done so beforehand. Type (within R)
install.packages("BiocManager") (This needs to be done just once.)

```{r, eval=FALSE, echo=TRUE}
install.packages("BiocManager")
BiocManager::install("tfkillian/depmap")
```

## Data Import {#sec:data}

The [depmap](https://github.com/tfkillian/depmap/) package currently contains 
seven datasets in *.rda* format. These datasets can be loaded by using *data()*
after this package has been installed and loaded in RStudio with
*library("depmap")*. The data found in this R package has been converted from 
wide format to long format, although none of the values taken from the original 
datasets have been changed. The code describing the data transformation is 
decribed in the make_data.R file found in ./depmap/inst/scripts 

```{r, eval=FALSE, echo=TRUE}
library("depmap")
#load(package_version())
```

### `metadata` 
The `metadata` dataset contains the metadata about all of the cancer cell lines.
It corresponds to the `depmap_19Q1_cell_lines.csv` file found in the most recent
19Q1 depmap release. This dataset includes 0 Genes, 1677 Cell Lines, 38 Primary
Diseases and 33 Lineages. 

```{r, eval=FALSE, echo=TRUE}
data("metadata", package = "depmap")
metadata
dim(metadata)
# [1] 1676    9
head(metadata)
# # A tibble: 6 x 9
#   depmapID cellLine Aliases COSMIC_ID `Sanger ID` `Primary Diseas…
#   <chr>    <chr>    <chr>       <dbl>       <dbl> <chr>           
# 1 ACH-000… NIHOVCA… NIH:OV…    905933        2201 Ovarian Cancer  
# 2 ACH-000… HL60_HA… HL-60      905938          55 Leukemia        
# 3 ACH-000… CACO2_L… CACO2;…        NA          NA Colon/Colorecta…
# 4 ACH-000… HEL_HAE… HEL        907053         783 Leukemia        
# 5 ACH-000… HEL9217… HEL 92…        NA          NA Leukemia        
# 6 ACH-000… MONOMAC… MONO-M…    908148        2167 Leukemia        
# # … with 3 more variables: `Subtype Disease` <chr>, Gender <chr>,
# #   Source <chr>
```

### `mutationCalls` 
The `mutationCalls` dataset contains all merged mutation calls (coding region, 
germline filtered) found in the depmap dependency study. This dataset 
corresponds with the `depmap_19Q1_mutation_calls.csv` file found in the most 
recent 19Q1 depmap release and includes 18755 Genes, 1601 Cell Lines, 37 Primary
Diseases and 33 Lineages. 

```{r, eval=FALSE, echo=TRUE}
data("mutationCalls", package = "depmap")
mutationCalls
dim(mutationCalls)
# [1] 1243145      35
head(mutationCalls)
#     depmapID Hugo_Symbol Entrez_Gene_Id NCBI_Build Chromosome Start_position
# 1 ACH-000001      VPS13D          55187         37          1       12359347
# 2 ACH-000001     AADACL4         343066         37          1       12726308
# 3 ACH-000001      IFNLR1         163702         37          1       24484172
# 4 ACH-000001      TMEM57          55219         37          1       25785018
# 5 ACH-000001     ZSCAN20           7579         37          1       33954141
# 6 ACH-000001      POU3F1           5453         37          1       38512139
```

### `rnai` 
The `rnai` dataset contains the combined genetic dependency data for RNAi-
induced gene knockdown for select cancer cell lines. This data corresponds to 
the `D2_combined_genetic_dependency_scores.csv` file found in the most recent 
19Q1 depmap release and includes 17309 genes, 711 cell lines 711, 30 primary 
diseases and 31 lineages. 

```{r, eval=FALSE, echo=TRUE}
data("rnai", package = "depmap")
rnai
dim(rnai)
# [1] 12324008        6
head(rnai)
# A tibble: 6 x 6
#   gene       cell_line       dependency entrez_id gene_name depmapID 
#   <chr>      <chr>                <dbl> <chr>     <chr>     <fct>    
# 1 A1BG (1)   127399_SOFT_TI…     NA     1         A1BG      ACH-0012…
# 2 NAT2 (10)  127399_SOFT_TI…     NA     10        NAT2      ACH-0012…
# 3 ADA (100)  127399_SOFT_TI…     NA     100       ADA       ACH-0012…
# 4 CDH2 (100… 127399_SOFT_TI…     -0.195 1000      CDH2      ACH-0012…
# 5 AKT3 (100… 127399_SOFT_TI…     -0.256 10000     AKT3      ACH-0012…
# 6 MED6 (100… 127399_SOFT_TI…     -0.174 10001     MED6      ACH-0012…
```

### `crispr`
The `crispr` dataset contains the (batch corrected CERES inferred gene effect) 
CRISPR-Cas9 knockout data of select genes and cancer cell lines. This data 
corresponds to the `gene_effect_corrected.csv` file from the most recent 19Q1 
depmap release. Data from this dataset includes 17634 Genes, 558 Cell Lines, 26 
Primary Diseases, 28 Lineages. 

```{r, eval=FALSE, echo=TRUE}
data("crispr", package = "depmap")
crispr
dim(crispr)
# [1] 9839772       6
head(crispr)
# A tibble: 6 x 6
#   depmapID   gene   dependency entrez_id gene_name cellLine                    
#   <chr>      <chr>       <dbl> <chr>     <chr>     <fct>                       
# 1 ACH-000004 A1BG …     0.135  1         A1BG      HEL_HAEMATOPOIETIC_AND_LYMP
# 2 ACH-000005 A1BG …    -0.212  1         A1BG      HEL9217_HAEMATOPOIETIC_AND_
# 3 ACH-000007 A1BG …     0.0433 1         A1BG      LS513_LARGE_INTESTINE       
# 4 ACH-000009 A1BG …     0.0705 1         A1BG      C2BBE1_LARGE_INTESTINE      
# 5 ACH-000011 A1BG …     0.191  1         A1BG      253J_URINARY_TRACT          
# 6 ACH-000012 A1BG …    -0.0104 1         A1BG      HCC827_LUNG           
```

### `copyNumber` 
The `copyNumber` dataset contains the WES copy number data, relating to the 
numerical log-fold copy number change measured against copy number baseline of 
select genes and cell lines found in the depmap dependency study. This dataset 
corresponds to the `public_19Q1_gene_cn.csv` from the most recent 19Q1 depmap 
release. This dataset includes 23299 Genes, 1604 Cell Lines, 38 Primary Diseases
and 33 Lineages. 

```{r, eval=FALSE, echo=TRUE}
data("copyNumber", package = "depmap")
copyNumber
dim(copyNumber)
# [1] 37371596        6
head(copyNumber)
# # A tibble: 6 x 6
#   depmapID   gene     logCopyNumber entrez_id gene_name cellLine                           
#   <chr>      <chr>            <dbl> <chr>     <chr>     <fct>                              
# 1 ACH-000011 A1BG (1)       0.131   1         A1BG      253J_URINARY_TRACT                 
# 2 ACH-000026 A1BG (1)      -0.237   1         A1BG      253JBV_URINARY_TRACT               
# 3 ACH-000086 A1BG (1)       0.134   1         A1BG      ACCMESO1_PLEURA                    
# 4 ACH-000557 A1BG (1)      -0.0208  1         A1BG      AML193_HAEMATOPOIET...
# 5 ACH-000838 A1BG (1)       0.170   1         A1BG      AMO1_HAEMATOPOIETIC...
# 6 ACH-000080 A1BG (1)       0.00703 1         A1BG      BDCM_HAEMATOPOIETIC...
```

### `TPM`
The `TPM` dataset contains the CCLE RNAseq gene expression data (using scale 
log2(TPM+1)). This shows expression data only for protein coding genes. This 
data corresponds to the `CCLE_depMap_19Q1_TPM.csv` file from the most recent 
19Q1 depmap release. This dataset includes 57820 Genes, 1165 Cell Lines, 33 
Primary Diseases, 32 Lineages.

```{r, eval=FALSE, echo=TRUE}
data("TPM", package = "depmap")
TPM
dim(TPM)
# [1] 67360300        6
head(TPM)
# # A tibble: 6 x 6
#   depmapID  gene           expression ensembl_id    gene_name cellLine         
#   <chr>     <chr>               <dbl> <chr>         <chr>     <fct>            
# 1 ACH-0009… TSPAN6 (ENSG0…       2.65 ENSG00000000… TSPAN6    22RV1_PROSTATE   
# 2 ACH-0009… TSPAN6 (ENSG0…       3.00 ENSG00000000… TSPAN6    2313287_STOMACH  
# 3 ACH-0000… TSPAN6 (ENSG0…       4.57 ENSG00000000… TSPAN6    253JBV_URINARY
# 4 ACH-0000… TSPAN6 (ENSG0…       4.58 ENSG00000000… TSPAN6    253J_URINARY_
# 5 ACH-0003… TSPAN6 (ENSG0…       4.59 ENSG00000000… TSPAN6    42MGBA_CENTRAL
# 6 ACH-0009… TSPAN6 (ENSG0…       5.88 ENSG00000000… TSPAN6    5637_URINARY_
```

### `RPPA`
The `RPPA` dataset contains the CCLE Reverse Phase Protein Array (RPPA) data.
data which corresponds to the `CCLE_RPPA_20180123.csv` file from the most 
recent 19Q1 depmap release. This dataset includes 214 Genes, 899 Cell Lines, 28 
Primary Diseases, 28 Lineages. 

```{r, eval=FALSE, echo=TRUE}
data("RPPA", package = "depmap")
RPPA
dim(RPPA)
# [1] 192386      4
head(RPPA)
# # A tibble: 6 x 4
#   cellLine                                 antibody    expression depmapID  
#   <chr>                                    <chr>            <dbl> <fct>     
# 1 DMS53_LUNG                               14-3-3_beta    -0.105  ACH-000698
# 2 SW1116_LARGE_INTESTINE                   14-3-3_beta     0.359  ACH-000489
# 3 NCIH1694_LUNG                            14-3-3_beta     0.0287 ACH-000431
# 4 P3HR1_HAEMATOPOIETIC_AND_LYMPHOID_TISSUE 14-3-3_beta     0.120  ACH-000707
# 5 HUT78_HAEMATOPOIETIC_AND_LYMPHOID_TISSUE 14-3-3_beta    -0.269  ACH-000509
# 6 UMUC3_URINARY_TRACT                      14-3-3_beta    -0.171  ACH-000522
```

### Downloading [Broad Institute](https://depmap.org/portal/download/) data 

If desired, the original long form data which was used to create the datasets
found in the [depmap](https://github.com/tfkillian/depmap/) package can be 
downloaded from the [Broad Institute](https://depmap.org/portal/download/) 
website. The instructions on how to download these files and how the data was 
trainsformed and loaded into the [depmap](https://github.com/tfkillian/depmap/) 
package can be found in the make_data.R file found in ./inst/scripts. (It should
be noted that the original un-compressed *.csv* files are 1.5GB in total and 
take a moderate amount of time to download.)

## Visualisations

Below are a few plots to help illustrate features of the 
[depmap](https://github.com/tfkillian/depmap/) data. The data loaded in this 
package is taken from a diverse array of cancer lineages, intended to represent 
the full spectrum of cancer. 

################

```{r}

```


```{r, eval=TRUE, echo=FALSE, fig.width=10}
library(ggplot2, warn.conflicts = FALSE) 
library(viridis, warn.conflicts = FALSE)

#select data columns
cancerTypes <-unique(metadata$Primary.Disease)
numCancer <-(as.integer(cancerTypes))

#plot pie
pie(x=numCancer, label = "", init.angle = 90, 
    col = plasma(length(cancerTypes)), 
    main = "Proportion of 501 Cancer Lineages Represented in DepMap")
legend("left", legend=cancerTypes, fill=plasma(length(cancerTypes)))
```

Barplots of cancer mutation types

```{r, eval=TRUE, echo=FALSE}
library(gridExtra)
library(grid)

# Barplot of cancer mutation types
p1 <- ggplot(mutationCalls, aes(x=factor(Variant_Classification)))+ 
    geom_bar(stat="Count", width=0.9, fill="steelblue")+theme_minimal() +
    ggtitle("Mutation class") 

# Horizontal bar plot
p2 <- (p1 + coord_flip() + theme_gray())

# Barplot of cancer mutation types (SNP)
p3 <- ggplot(mutationCalls, aes(x=factor(Variant_Type))) +
    geom_bar(stat="Count", width=0.7, fill="steelblue")+theme_minimal() +
    ggtitle("Mutations type") 

# Horizontal bar plot
p4 <- (p3 + coord_flip() + theme_gray())

#plot as 1x2 grid
grid.arrange(p2, p4, nrow = 1, top = "Depmap Cancer Mutations")
```

Much of the data that can be found within datasets of the the 
[depmap](https://github.com/tfkillian/depmap/) package relates to the dependency 
score. This score represents the a scored (derived from processing via machine 
learning algorithms such as CERES or DEMETER2) which observe the shRNA log fold
change (LFC) depletion values in each cell line (CL) after 16 generations after 
gene knockdown/knockout. This dependency score is intended to express how vital 
a particular gene is in terms of how lethal the knockout/knockdown of that gene 
is on a target cell line. A highly negative dependency score is indicative of 
high lethality and therefore implying that that cell line is highly dependent on
that gene. Whereas, a positive score indicates improved vitality of a given 
cancer cell line. A dependency score of zero would indicate little to no effect
on vitality of gene knockout/knockdown.   

We will demonstrate how to obtain single dependency scores corresponding to a
specific gene and cell lineage. For example, we would like to know what 
dependency is present for a well known human tumor suppressor gene, like `BRCA1`
when it is knocked down via RNAi in a breast cancer lineage such as 
`184A1_BREAST`. This data can be found in the `rnai` dataset. 

```{r, eval=TRUE, echo=TRUE}
#select row and column and print dependency score
dsBRCA1breast <- rnai$`BRCA1 (672)`[which(rnai$cellLine=="184A1_BREAST")]
BRCA1val <- paste("Dep score for BRCA1 on 184A1_BREAST CL: ", dsBRCA1breast)
print(BRCA1val)
# "Dependency score for is BRCA1 on 184A1_BREAST CL is:  1.441402e-02"

#avg gene dependency
brca1DSavg <- mean(na.omit(rnai$`BRCA1 (672)`))
brca1DSavgVal <- paste("Avg BRCA1 dep score for all cell lines: ", brca1DSavg)
print(brca1DSavgVal)
# [1] "Avg BRCA1 dep score for all cell lines:  -0.157957653751371"
```

If we would like to investigate a specific gene and obtain the highest and 
lowest dependency scores via RNAI knock down for `BRCA1` along with the cancer 
cell lines associated with those values:

```{r, eval=TRUE, echo=TRUE}
#sort dependencies scores of particular gene (BRCA1) by lowest (most important)
lowBRCA1vals <-rnai[order(rnai$`BRCA1 (672)`, decreasing=FALSE)[1:10],]

#sort dependencies scores of particular gene (BRCA1) my highest (most important)
highBRCA1vals <-rnai[order(rnai$`BRCA1 (672)`, decreasing=TRUE)[1:10],]

# cbind as df
lowBRCA1 <- cbind(lowBRCA1vals$cellLine, lowBRCA1vals$`BRCA1 (672)`)
highBRCA1 <- cbind(highBRCA1vals$cellLine, highBRCA1vals$`BRCA1 (672)`)

print("Dependency scores for least 10 dependent cell lines for BRCA1 knockout")
highBRCA1 
#[1] "Dependency scores for least 10 dependent cell lines for BRCA1"
#      [,1]                             [,2]            
# [1,] "COLO678_LARGE_INTESTINE"        "0.487047073406"
# [2,] "ME180_CERVIX"                   "0.385984728794"
# [3,] "NCIH441_LUNG"                   "0.328893752785"
# [4,] "SQ1_LUNG"                       "0.309676934191"
# [5,] "CAKI1_KIDNEY"                   "0.260905572242"
# [6,] "D341MED_CENTRAL_NERVOUS_SYSTEM" "0.251014543174"
# [7,] "CW2_LARGE_INTESTINE"            "0.243416457789"
# [8,] "NCIH2291_LUNG"                  "0.235890487173"
# [9,] "NCIH1838_LUNG"                  "0.233686468271"
# [10,] "SNUC1_LARGE_INTESTINE"          "0.232145267234"

print("Dependency scores for top 10 dependent cell lines for BRCA1 knockout")
lowBRCA1 
#[1] "Dependency scores for top 10 dependent cell lines for BRCA1"
#  [,1]                           [,2]             
# [1,] "SMSCTR_SOFT_TISSUE"           "-0.815179289727"
# [2,] "JHOS2_OVARY"                  "-0.797872793957"
# [3,] "OVCAR8_OVARY"                 "-0.770237364698"
# [4,] "HCC1806_BREAST"               "-0.725152639186"
# [5,] "KPNSI9S_AUTONOMIC_GANGLIA"    "-0.709283349083"
# [6,] "HCC202_BREAST"                "-0.699951441734"
# [7,] "KMRC2_KIDNEY"                 "-0.680812400649"
# [8,] "DMS53_LUNG"                   "-0.646703047947"
# [9,] "M059K_CENTRAL_NERVOUS_SYSTEM" "-0.639093264076"
# [10,] "MDAMB330_BREAST"              "-0.616680884067"
```

If we would like to obtain the highest and lowest dependency scores for a 
certain cell line (for example `184A1_BREAST`) along with the genes associated 
with those values:

```{r, eval=TRUE, echo=TRUE}
# need to remove the columns with characters in `rnai` before finding max/min
rnai0Chars <- subset(rnai, select = -c(depmapID, cellLine))

# select row of rnai "184A1_BREAST"
breastRow <-which(rnai$cellLine=="184A1_BREAST")

# find column and value for lowest dep scoring gene for cell line "184A1_BREAST"
breastRowMin <-which.min(rnai0Chars[breastRow,])
breastRowMinVal <-rnai0Chars[breastRow,breastRowMin]
print("Gene with highest dependency score for cell line 184A1_BREAST")
breastRowMin
breastRowMinVal
# [1] "Gene with highest dependency score for cell line 184A1_BREAST"
# SF3B1 (23451) 
#         4888 
# [1] -2.29743

# find column and value for lowest dep scoring gene for cell line "184A1_BREAST"
breastRowMax <-which.max(rnai0Chars[breastRow,])
breastRowMaxVal <-rnai0Chars[breastRow,breastRowMax]
print("Gene with lowest dependency score for cell line 184A1_BREAST")
breastRowMax
breastRowMaxVal
# [1] "Gene with lowest dependency score for cell line 184A1_BREAST"
# TADA2A (6871) 
#        13331 
# [1] 1.430731

# find average value for dependency score for cell line "184A1_BREAST"
breastDSavg <-rowMeans(rnai0Chars[breastRow,], na.rm = TRUE, dims = 1)
print("Average gene dependency score for cell line 184A1_BREAST")
breastDSavg
#           4 
# -0.03864402 
```

Below shows a table which returns the 10 most significant (cancer-depleting) 
genes and their dependency scores for the `rnai` data, along with corresponding
cell line for that value. 

```{r, eval=TRUE, echo=FALSE}
# load dplyr
library(dplyr, warn.conflicts = FALSE)

# get gene columns from `rnai` subset `rnai0Chars`
geneNamesRNAI <-as.data.frame(names(rnai0Chars))

# add ID to list of genes (to merge at a later step)
geneNamesRNAI <- tibble::rowid_to_column(geneNamesRNAI, "ID")

# add col names
colnames(geneNamesRNAI, do.NULL = FALSE)
colnames(geneNamesRNAI) <- c("ID", "Gene")

# Return column index (gene) of each row minimum (cell line)
rnaiMinCols <- (apply(rnai0Chars, 1, which.min))

# lowest dependency scores for each column (cell line) of `rnai`
lowDepScoresColRNAI <- apply(rnai0Chars, 1, function(x) {min(x, na.rm = TRUE)})

# coerce to dataframe
rnaiMinCols <- as.data.frame(rnaiMinCols)
lowDepScoresColRNAI <- as.data.frame(lowDepScoresColRNAI)

# cbind `lowDepScoresColRNAI` and `rnaiMinCols`
rnaiDepScoreMinAndColIndex <- cbind(lowDepScoresColRNAI, rnaiMinCols)

# add col names
colnames(rnaiDepScoreMinAndColIndex, do.NULL = FALSE)
colnames(rnaiDepScoreMinAndColIndex) <- c("DepScore", "ID")

#left_join on ID
rnaiDepMinCellGene <- left_join(rnaiDepScoreMinAndColIndex, geneNamesRNAI, all=TRUE)

# cbind `rnai$cellLine` and `depMinCellGene`
rnaiDepScoreMinAndColIndex <- cbind(rnai$cellLine, rnaiDepMinCellGene)

# remove superfluous ID column
rnaiDepScoreMinAndColIndex <-subset(rnaiDepScoreMinAndColIndex, select = -c(ID))

#rename first column
names(rnaiDepScoreMinAndColIndex)[1] <- "cellLine"

# sort by highest dependencies 
top25rnai<-rnaiDepScoreMinAndColIndex[order(rnaiDepScoreMinAndColIndex$DepScore, 
                                             decreasing=FALSE)[1:25],]
top25rnai 

# if we want to do the same as above, but column-wise

# Return min row index
# rnaiMinRows <- (apply(rnai0Chars,1,which.min))

# lowest dependency scores for each column of `rnai`
# lowDepScoresRowRNAI <-apply(rnai0Chars, 2, function(x) {min(x, na.rm = TRUE)})
```

Below shows a table which returns the 10 least significant (most cancer-driving) 
dependency scores for genes in the `rnai` data, along with corresponding cell 
line for that value. It may be interesting to compare these values with those 
found from the previous table.

```{r, eval=TRUE, echo=FALSE}
# load dplyr
# library(dplyr, warn.conflicts = FALSE)

# Return column index (gene) of each row max (cell line)
rnaiMaxCols <- (apply(rnai0Chars, 1, which.max))

# highest dependency scores for each column (cell line) of `rnai`
highDepScoresColRNAI <- apply(rnai0Chars, 1, function(x) {max(x, na.rm = TRUE)})

# coerce to dataframe
rnaiMaxols <- as.data.frame(rnaiMaxCols)
highDepScoresColRNAI <- as.data.frame(highDepScoresColRNAI)

# cbind `highDepScoresColRNAI` and `rnaiMaxCols`
rnaiDepScoreMaxAndColIndex <- cbind(highDepScoresColRNAI, rnaiMaxCols)

# add col names
colnames(rnaiDepScoreMaxAndColIndex, do.NULL = FALSE)
colnames(rnaiDepScoreMaxAndColIndex) <- c("DepScore", "ID")

#left_join on ID
depMaxCellGene <- left_join(rnaiDepScoreMaxAndColIndex, geneNamesRNAI, all=TRUE)

# cbind `rnai$cellLine` and `depMaxCellGene`
rnaiDepScoreMaxAndColIndex <- cbind(rnai$cellLine, depMaxCellGene)

# remove superfluous ID column
rnaiDepScoreMaxAndColIndex <-subset(rnaiDepScoreMaxAndColIndex, select = -c(ID))

#rename first column
names(rnaiDepScoreMaxAndColIndex)[1] <- "cellLine"

# sort by highest dependencies 
bot25rnai<-rnaiDepScoreMaxAndColIndex[order(rnaiDepScoreMaxAndColIndex$DepScore, 
                                             decreasing=TRUE)[1:25],]
bot25rnai
```

We will do the same for what we did for the `rnai` data shown above (finding the 
population of genes with highest and lowest dependency scores) for the `crispr` 
data, as shown below. 

```{r, eval=TRUE, echo=FALSE}
# load dplyr
# library(dplyr, warn.conflicts = FALSE)

# need to remove the columns with characters in `crispr` before finding max/min
crispr0Chars <- subset(crispr, select = -c(depmapID, cellLine))

# get gene columns from `crispr` subset `crispr0Chars`
geneNamesCRISPR <-as.data.frame(names(crispr0Chars))

# add ID to list of genes (to merge at a later step)
geneNamesCRISPR <- tibble::rowid_to_column(geneNamesCRISPR, "ID")

# add col names
colnames(geneNamesCRISPR, do.NULL = FALSE)
colnames(geneNamesCRISPR) <- c("ID", "Gene")

# return column index (gene) of each row minimum (cell line)
crisprMinCols <- (apply(crispr0Chars, 1, which.min))

# lowest dependency scores for each column (cell line) of `crispr`
lowDepScoresColCRISPR <- apply(crispr0Chars, 1, 
                               function(x) {min(x, na.rm = TRUE)})
# coerce to dataframe
crisprMinCols <- as.data.frame(crisprMinCols)
lowDepScoresColCRISPR <- as.data.frame(lowDepScoresColCRISPR)

# cbind `lowDepScoresColCRISPR` and `crisprMinCols`
crisprDepScoreMinAndColIndex <- cbind(lowDepScoresColCRISPR, crisprMinCols)

# add col names
colnames(crisprDepScoreMinAndColIndex, do.NULL = FALSE)
colnames(crisprDepScoreMinAndColIndex) <- c("DepScore", "ID")

# left_join on ID
crisprDepMinCellGene <- left_join(crisprDepScoreMinAndColIndex, geneNamesCRISPR, all=TRUE)

# cbind `crispr$cellLine` and `depMinCellGene`
crisprDepScoreMinAndColIndex <- cbind(crispr$cellLine, crisprDepMinCellGene)

# remove superfluous ID column
crisprDepScoreMinAndColIndex <-subset(crisprDepScoreMinAndColIndex, 
                                      select = -c(ID))
#rename first column
names(crisprDepScoreMinAndColIndex)[1] <- "cellLine"

# sort by highest dependencies 
top25crispr<-crisprDepScoreMinAndColIndex[order(crisprDepScoreMinAndColIndex$DepScore, 
                                             decreasing=FALSE)[1:25],]
top25crispr 
```

Below shows a table which returns the 10 least significant (most cancer-driving) 
dependency scores for genes in the `crispr` data, along with corresponding cell 
line for that value.

```{r, eval=TRUE, echo=FALSE}
# load dplyr
# library(dplyr, warn.conflicts = FALSE)

# return column index (gene) of each row max (cell line)
crisprMaxCols <- (apply(crispr0Chars, 1, which.max))

# highest" dependency scores for each column (cell line) of `crispr`
highDepScoresColCRISPR <- apply(crispr0Chars, 1, 
                               function(x) {max(x, na.rm = TRUE)})
# coerce to dataframe
crisprMaxCols <- as.data.frame(crisprMaxCols)
highDepScoresColCRISPR <- as.data.frame(highDepScoresColCRISPR)

# cbind `highDepScoresColCRISPR` and `crisprMaxCols`
crisprDepScoreMaxAndColIndex <- cbind(highDepScoresColCRISPR, crisprMaxCols)

# add col names
colnames(crisprDepScoreMaxAndColIndex, do.NULL = FALSE)
colnames(crisprDepScoreMaxAndColIndex) <- c("DepScore", "ID")

# left_join on ID
crisprDepMaxCellGene <- left_join(crisprDepScoreMaxAndColIndex, geneNamesCRISPR, all=TRUE)

# cbind `crispr$cellLine` and `depMaxCellGene`
crisprDepScoreMaxAndColIndex <- cbind(crispr$cellLine, crisprDepMaxCellGene)

# remove superfluous ID column
crisprDepScoreMaxAndColIndex <-subset(crisprDepScoreMaxAndColIndex, 
                                      select = -c(ID))
#rename first column
names(crisprDepScoreMaxAndColIndex)[1] <- "cellLine"

# sort by highest dependencies 
bot25crispr<-crisprDepScoreMaxAndColIndex[order(crisprDepScoreMaxAndColIndex$DepScore, 
                                             decreasing=TRUE)[1:25],]
bot25crispr 
```

Below are a series of additional plots to help illustrate structures in the 
data. 

```{r}
# boxplot of high and low dependency score `rnai`

# get top 10 scoring genes `rnai`
uniqueTop25RnaiGene <- unique(top25rnai$Gene)
uniqueTop5RnaiGene <- uniqueTop25RnaiGene[1:5]
str(uniqueTop5RnaiGene)
View(uniqueTop25RnaiGene)

```

```{r}
# get bottom 10 scoring genes `rnai`
uniqueBot25RnaiGene <- unique(bot25rnai$Gene)
uniqueBot25RnaiGene
```

```{r}
# boxplot of high and low dependency score `crispr`

# get top 10 scoring genes `crispr`
uniqueTop25crisprGene <- unique(top25crispr$Gene)
uniqueTop25crisprGene
```

```{r}

# get bottom 10 scoring genes `crispr`
uniqueBot25crisprGene <- unique(bot25crispr$Gene)
uniqueBot25crisprGene
```

```{r}
# boxplot of high and low dependency score 

```

```{r}
# boxplot of high and low dependency score 

```

```{r, eval=FALSE, echo=T}
library(tidyverse, warn.conflicts = FALSE)
require(reshape2, warn.conflicts = FALSE)

## p5 - plot of dependency scores of 184A1_Breast
# omit genes with NA dependency and coerce into data frame
breastNoNA <-as.data.frame(na.omit(t(rnai0Chars[breastRow,])))

# add an ID column
breastNoNA <- tibble::rowid_to_column(breastNoNA, "ID")
Breast_184A1 <-breastNoNA

# add col names
colnames(Breast_184A1, do.NULL = FALSE)
colnames(Breast_184A1) <- c("Gene","Dependency")

# p1 - plot gene dependency levels for 184A1_BREAST cell line
p5 <-ggplot(Breast_184A1) + 
    aes(Gene, Dependency, color = Breast_184A1$Dependency) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=breastDSavg, linetype="dashed", color = "black") +
    ggtitle("Avg. RNAi dep. scores for each gene for cell line 184A1_Breast")

# p6 - boxplot of dependency scores of first 10 genes in `rnai`
# subset first 10 columns of `rnai` to create `first10Rnai`
first10Rnai <- rnai[3:13]

p6 <- ggplot(data = melt(first10Rnai), aes(x=variable, y=value)) + 
    geom_boxplot(aes(fill=variable)) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
    ggtitle("Boxplot of dependency scores of first 10 genes in `rnai` dataset")

## p7 - plot of the lowest dep. scores for each gene for `rnai` data 
# apply function to get mean dependency of each gene from all columns
rnaiColAvg <- apply(rnai[c(3:17311)], 2, function(x) {mean(x, na.rm = TRUE)})
rnaiColAvgVal <- mean(rnaiColAvg)
# -0.06833473

#coerce into data frame
depAllGenes <- as.data.frame(t(rnaiColAvg))
depAllGenes <- tibble::rowid_to_column(depAllGenes, "ID")
names(depAllGenes)

#plot gene dependency levels for all cell lines
p7 <-ggplot(depAllGenes) + 
    aes(ID, Dependency_Score, color = depAllGenes$Dependency) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=rnaiColAvgVal, linetype="dashed", color = "black") + 
    geom_hline(yintercept=df3_avg, linetype="dashed", color = "red") +
    labs(y = "Dep Score of Gene with Largest Dep Score", x = "Cell Line") + 
    ggtitle("Greatest RNAi dependency scores for each gene by cell line") +
    scale_linetype_manual(name = "Avg dep scores",values = c(2,2))

# I will add a legend to the lines when I have time

#plot as 1x2 grid
grid.arrange(p5, p6, p7, nrow = 1, top = "Depmap Data Visualizations")

```

It might be interesting to locate the highest scoring dependencies among all 
cell lines for the CRISPR dataset as well.

```{r, eval=FALSE, echo=T}
# function that finds highest dependency scores for each gene and cell line

lowDepScoresCRISPR <- apply(crispr[c(2:17635)], 1, function(x) {min(x, na.rm = TRUE)})

#lowDepGeneCRISPR <- apply(crispr[c(2:17635)], 1, function(x) {depmin <-which.min(x) crispr[depmin]})

# coerce into data frame
lowDepScoresCRISPR <- as.data.frame(lowDepScoresCRISPR)
lowDepGeneCRISPR <- as.data.frame(lowDepGeneCRISPR)

df4<-cbind(lowDepGeneCRISPR, lowDepScoresCRISPR)

colnames(df4, do.NULL = FALSE)
colnames(df4) <- c("Gene","Dependency_Score", "Num")

# sort by 10 highest dependencies 
top10CRISPR <-df4[order(df4$Dependency_Score, decreasing=F)[1:10],]
top10CRISPR
```

Below is a plot of the lowest dependency scores for each gene and CL for the 
`crispr` dataset. 
 
```{r, eval=FALSE, echo=T}
# apply function to get mean dependency from all columns
gEc_avg <- apply(crispr[c(2:17635)], 1, function(x) {mean(x, na.rm = TRUE)})

gEc_avg2 <- mean(gEc_avg)
# -0.06833473

# apply function to get mean HIGHEST dependency from all columns
df4_avg <- mean(df4$Dependency_Score)
# -2.198807

#coerce into data frame
df4 <- as.data.frame(df4)
#df3 <- tibble::rowid_to_column(df3, "ID")
#View(df3)
depAllGenesCRISPR <-df4 

#plot gene dependency levels for all cell lines
ggplot(depAllGenesCRISPR) + aes(Num, Dependency_Score, color = depAllGenesCRISPR$Dependency_Score) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=gEc_avg2, linetype="dashed", color = "black") + 
    geom_hline(yintercept=df4_avg, linetype="dashed", color = "red") +
    labs(y = "Dep Score of Gene with Largest Dep Score", x = "Cell Line") + 
    ggtitle("Greatest CRISPR dependency scores for each gene by cell line") +
    scale_linetype_manual(name = "Avg dep scores",values = c(2,2))

# I will add a legend to the lines when I have time
```

It might be insightful to compare the dependency scores of datasets derived from
RNAi knockout e.g. `rnai` and those utilizing CRISPR knockouts e.g. `crispr`. 

```{r, eval=TRUE, echo=F}
# data wrangling for `crispr`

# Rename first column to "cellLine" to it can be merged with `metadata`
names(crispr)[1]<-"depmapID"

# map CCLE name onto DepmapID for crispr
geneToID <- full_join(crispr, metadata, all=TRUE)

# tidy up dataframe to make cellLine appear as the second column
depmapID <- geneToID$depmapID
cellLine <- geneToID$cellLine
geneToIDCols <- subset(cellToID3, select = -c(depmapID, cellLine))
geneIDcrispr <-cbind(depmapID, cellLine, geneToID)
geneIDcrispr <- geneIDcrispr[,-3] #remove reduncent depmapID column
```

```{r, eval=TRUE, echo=F}
# in order to plot the `crispr` (CRISPR) and `rnai`(RNAi) datasets, we will have
# to make them comparable, which means removing any NAs or genes that were not 
# tested in on or the other dataset. We will 1) remove all rows with NA for 
# dependency score for the PIK3C3 gene and 2) remove all genes (columns) that do
# not occur in both datasets, then 3) full_join on the cell lines (depmapID) in 
# common for the CRISPR and RNAi for the PIK3C3 gene dependencies of both 
# datasets 

# compare `depmapID` column of `geneIDcrispr` and `noNAdepIDrnai` 

# since the dimensions for `geneIDcrispr` and `noNAdepIDrnai` are the same, we
# will full_join on `depmapID` and create a new dataframe `depPIK3C3` with 
# depenency scores that can be compared between RNAi CRISPR datasets. Note: we
# use "cbind.data.frame" to avoid turning the numeric values into factors

crisprPIK3C3 <-cbind.data.frame(geneIDcrispr$depmapID, geneIDcrispr$`PIK3C3 (5289)`)
rnaiPIK3C3 <-cbind.data.frame(noNAdepIDrnai$depmapID, noNAdepIDrnai$`PIK3C3 (5289)`, stringsAsFactors = FALSE)

#rename column names 

#add col names to crisprPIK3C3 to make the variables more clear
colnames(crisprPIK3C3, do.NULL = FALSE)
colnames(crisprPIK3C3) <- c("depmapID","crisprPIK3C3")

#add col names to rnaiPIK3C3 to make the variables more clear
colnames(rnaiPIK3C3, do.NULL = FALSE)
colnames(rnaiPIK3C3) <- c("depmapID","rnaiPIK3C3")

#full_join on depmapID
comparePIK3C3 <- full_join(crisprPIK3C3, rnaiPIK3C3, all=TRUE)

#set all NAs to 0 for comparePIK3C3 so the dataframe can be visualized

# comparePIK3C3$rnaiPIK3C3 has to be turned into character because it throws 
# an annoying warning "invalid factor level, NA generated"
comparePIK3C3$rnaiPIK3C3<- as.character(comparePIK3C3$rnaiPIK3C3)
comparePIK3C3[, 1:3][is.na(comparePIK3C3[, 1:3])] <- 0

# comparePIK3C3$rnaiPIK3C3 converted back to numeric. Note: this is an inelegant
# solution, need to find something that works better 
comparePIK3C3$rnaiPIK3C3<- as.numeric(comparePIK3C3$rnaiPIK3C3)

#convert comparePIK3C3 to depPIK3C3, and convert 0 values to NA
depPIK3C3 <- comparePIK3C3
depPIK3C3[depPIK3C3==0] <- NA
depPIK3C3

#Delete the rows associated with NA.
compDepPIK3C3<-depPIK3C3[complete.cases(depPIK3C3),]
#View(compDepPIK3C3)
#dim(compDepPIK3C3)
#[1] 402   3
# this means that there are only 402 cell lines where there are dependency 
# scores for both RNAI and CRISPR. we will plot them in the chunk below

# sort byDepIdPIK3C3 by depmapID, lowest to highest
byDepIdPIK3C3 <- compDepPIK3C3[order(compDepPIK3C3$depmapID, decreasing=F),]
```

Now that the data wrangling for `rnai` and 
`crispr` is complete, we will attempt to visualize the difference
in dependency scores between the RNAi and CRISPR datasets. First, comparison for 
the dependency two genes between the two datasets will be produced, then a 
global comparison between the two datasets will be demonstrated.

We will begin by illustrating a histogram of the dependency scores for a 
particular gene, comparing CRISPR and RNAI.

Scatterplot of the dependency scores for RNAi knockouts for PIK3C3 using ggplot2

```{r, eval=FALSE, echo=T}
# histogram of the dependency scores for a particular gene taken from data-
# wrangled `crispr` and `rnai` datasets. We will first be visualizing the PIK3C3
# gene, which is one of # the most dependent genes in either dataset. We will do
# this by combining the geneIDcrispr$`PIK3C3 (5289)` and 
# noNAdepIDrnai$`PIK3C3 (5289)` columns into a single dataframe and plotting 
# with ggplot2 

avgCRISPR <-mean(byDepIdPIK3C3$crisprPIK3C3)
avgRNAI <-mean(byDepIdPIK3C3$rnaiPIK3C3)

#plot RNAI gene dependency levels for PIK3C3 for all complete cell lines 
ggplot(byDepIdPIK3C3) + aes(depmapID, byDepIdPIK3C3$rnaiPIK3C3, color = byDepIdPIK3C3$rnaiPIK3C3) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=avgRNAI, linetype="dashed", color = "red") +
    labs(y = "Dependency Score", x = "Cell Lines") + 
    ggtitle("Plot of the dependency scores for RNAi for PIK3C3") 
```

Scatterplot of dependency scores for CRISPR knockouts for PIK3C3 using ggplot2

```{r, eval=FALSE, echo=T}
#plot CRISPR gene dependency levels for PIK3C3 for all complete cell lines
ggplot(byDepIdPIK3C3) + aes(depmapID, byDepIdPIK3C3$crisprPIK3C3, color = byDepIdPIK3C3$crisprPIK3C3) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=avgCRISPR, linetype="dashed", color = "blue") + 
    labs(y = "Dependency Score", x = "Cell Lines") + 
    ggtitle("Plot of the dependency scores for CRISPR for PIK3C3") 
```

Overlay of dependency scores for RNAi and CRISPR knockouts for PIK3C3 

```{r, eval=FALSE, echo=T}
#overlay RNAI and CRISPR
library(lattice)
xyplot(crisprPIK3C3 + rnaiPIK3C3 ~ sequence(nrow(byDepIdPIK3C3)), data=byDepIdPIK3C3, 
       pch = 21, fill = c("blue", "red"), cex = 1, xlab=list("Cell Lines", cex=1.7), 
       ylab=list("Dependency Score for Gene", cex=1.5), 
       main=list("Dependency Score of PIKC3C for RNAi and CRISPR for all cell lines", cex=1.1),
       auto.key=list(space = "top", column = 2, title="Knockout Type", cex.title=1),
       panel = function(x, y, ...)
       {panel.xyplot(x, y, ...)  ## First call the default panel function for 'xyplot'
       panel.abline(h = avgCRISPR, col = 2, lty = 2)
       panel.abline(h = avgRNAI, col = 1, lty = 2)
       })
```

Plot CRISPR vs RNAi gene dependency levels for PIK3C3

```{r, eval=FALSE, echo=T}
#plot CRISPR vs RNAI gene dependency levels for PIK3C3 for all complete cell lines 
ggplot(byDepIdPIK3C3) + aes(rnaiPIK3C3, crisprPIK3C3, color = byDepIdPIK3C3$rnaiPIK3C3) + 
    geom_point() +  scale_colour_viridis() + 
    labs(y = "CRISPR Dependency Score", x = "RNAI Dependency Score") + 
    ggtitle("Dependency scores for RNAi vs CRISPR for PIKC3C") 
```

Compare CRISPR vs RNAi for COPB1

```{r, eval=FALSE, echo=T}
# since the dimensions for `geneIDcrispr` and `noNAdepIDrnai` are the same, we
# will full_join on `depmapID` and create a new dataframe `depCOPB1` with 
# depenency scores that can be compared between RNAi CRISPR datasets. Note: we
# use "cbind.data.frame" to avoid turning the numeric values into factors

crisprCOPB1 <-cbind.data.frame(geneIDcrispr$depmapID, geneIDcrispr$`COPB1 (1315)`)
rnaiCOPB1 <-cbind.data.frame(noNAdepIDrnai$depmapID, noNAdepIDrnai$`COPB1 (1315)`, stringsAsFactors = FALSE)

#rename column names 

#add col names to crisprCOPB1 to make the variables more clear
colnames(crisprCOPB1, do.NULL = FALSE)
colnames(crisprCOPB1) <- c("depmapID","crisprCOPB1")

#add col names to rnaiCOPB1 to make the variables more clear
colnames(rnaiCOPB1, do.NULL = FALSE)
colnames(rnaiCOPB1) <- c("depmapID","rnaiCOPB1")

#full_join on depmapID
compareCOPB1 <- full_join(crisprCOPB1, rnaiCOPB1, all=TRUE)
#View(compareCOPB1)

compDepCOPB1<-compareCOPB1[complete.cases(compareCOPB1),]
#View(compDepCOPB1)

compDepCOPB1$rnaiCOPB1<- as.numeric(as.character(compDepCOPB1$rnaiCOPB1))

byDepIdCOPB1 <- compDepCOPB1
```

CRISPR vs RNAi for COPB1

```{r, eval=FALSE, echo=T}
#plot CRISPR vs RNAI gene dependency levels for COPB1 for all complete cell lines 
ggplot(byDepIdCOPB1) + aes(rnaiCOPB1, crisprCOPB1, color = byDepIdCOPB1$rnaiCOPB1) + 
    geom_point() +  scale_colour_viridis() + 
    labs(y = "CRISPR Dependency Score", x = "RNAI Dependency Score") + 
    ggtitle("Dependency scores for RNAi vs CRISPR for COPB1") 
```


Overlay of dependency scores for RNAi and CRISPR knockouts for COPB1 

```{r, eval=FALSE, echo=T}
avgCRISPR2 <-mean(byDepIdPIK3C3$crisprCOPB1)
avgRNAI2 <-mean(byDepIdPIK3C3$rnaiCOPB1)

#overlay RNAI and CRISPR
library(lattice)
xyplot(crisprCOPB1 + rnaiCOPB1 ~ sequence(nrow(byDepIdCOPB1)), data=byDepIdCOPB1, 
       pch = 21, fill = c("blue", "red"), cex = 1, xlab=list("Cell Lines", cex=1.7), 
       ylab=list("Dependency Score for Gene", cex=1.5), 
       main=list("Dependency Score of COPB1 for RNAi and CRISPR for all cell lines", cex=1.1),
       auto.key=list(space = "top", column = 2, title="Knockout Type", cex.title=1),
       panel = function(x, y, ...)
       {panel.xyplot(x, y, ...)  ## First call the default panel function for 'xyplot'
       panel.abline(h = avgCRISPR2, col = 2, lty = 2)
       panel.abline(h = avgRNAI2, col = 1, lty = 2)
       })
```

Some data wrangling must be performed to visualize the differences in dependency 
for both RNAi and CRISPR datasets for all genes. 

```{r, eval=TRUE, echo=F}
# apply function to calculate the mean of all of the dependencies for each gene

# convert geneIDcrispr to geneIDcrispr2 so we can preserve original df
geneIDcrispr2 <- geneIDcrispr

# convert noNAdepIDrnai to noNAdepIDrnai2 so we can preserve original df
noNAdepIDrnai2 <- noNAdepIDrnai

#nremove columns with characters
geneIDcrispr2sub <- geneIDcrispr2[3:17311]

crisprCellMean <- apply(geneIDcrispr2sub, 1, mean, na.rm = TRUE)

crisprGeneMean <- apply(geneIDcrispr2sub, 2, mean, na.rm = TRUE)

#remove columns with characters
noNAdepIDrnai2sub <- noNAdepIDrnai2[3:17311]

# the columns of noNAdepIDrnai2sub were converted to factors somehow, and we
# will be converting them back to numeric in order to plot or manipulate them
indx <- sapply(noNAdepIDrnai2sub, is.factor)
noNAdepIDrnai2sub[indx] <- lapply(noNAdepIDrnai2sub[indx], 
                                  function(x) as.numeric(as.character(x)))

rnaiCellMean <- apply(noNAdepIDrnai2sub, 1, mean, na.rm = TRUE)

rnaiGeneMean <- apply(noNAdepIDrnai2sub, 2, mean, na.rm = TRUE)

# now we need to make combined dataframes of CellMean and GeneMean
# (it's easier to manipulate and plot if they are in one dataframe)

# cbind the CellMeans
cellMeans <-cbind(crisprCellMean, rnaiCellMean)

#add col names to cellMeans to make the variables more clear
colnames(cellMeans, do.NULL = FALSE)
colnames(cellMeans) <- c("CRISPRavgCellDep","RNAIavgCellDep")

#coerce into data frame
cellMeans <- as.data.frame(cellMeans)

# add sequence number 
cellMeans <- tibble::rowid_to_column(cellMeans, "ID")

# cbind the GeneMeans
geneMeans <-cbind(crisprGeneMean, rnaiGeneMean)

#add col names to cellMeans to make the variables more clear
colnames(geneMeans, do.NULL = FALSE)
colnames(geneMeans) <- c("CRISPRavgGeneDep","RNAIavgGeneDep")

#coerce into data frame
geneMeans <- as.data.frame(geneMeans)

# add sequence number 
geneMeans <- tibble::rowid_to_column(geneMeans, "ID")

# there are a lot of missing averages in CellMeans (oddly enough), we will only
# visualise the complete cases

#Delete the rows associated with NA.
compCellMeans<-cellMeans[complete.cases(cellMeans),]

#Delete the rows associated with NA.
compGeneMeans<-geneMeans[complete.cases(geneMeans),]

# calculate averages to show in plots

# total average CRISPR Gene dependency for all genes
totalAvgCrisprGene <- mean(geneMeans$CRISPRavgGeneDep, na.rm = TRUE)

# total average RNAi Gene dependency for all genes
totalAvgRNAiGene <- mean(geneMeans$RNAIavgGeneDep, na.rm = TRUE)

# total average CRISPR Gene dependency for all cell lines
totalAvgCrisprCell <- mean(cellMeans$CRISPRavgCellDep, na.rm = TRUE)

# total average RNAi Gene dependency for all cell lines
totalAvgRNAiCell <- mean(cellMeans$RNAIavgCellDep, na.rm = TRUE)
```

Plot of avg CRISPR dep scores for all Cell Lines

```{r, eval=FALSE, echo=T}
#Plot of avg CRISPR dep scores for all genes
ggplot(compCellMeans) + aes(ID, CRISPRavgCellDep, color = CRISPRavgCellDep) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=totalAvgCrisprCell, linetype="dashed", color = "blue") + 
    labs(y = "Average dependency score per cell line", x = "Cell Lines") + 
    ggtitle("Average CRISPR dependency scores for all Cell Lines") 
```

Plot of average RNAI dependency scores for all cell lines

```{r, eval=FALSE, echo=T}
#Plot of avg RNAI dep scores for all genes
ggplot(compCellMeans) + aes(ID, RNAIavgCellDep, color = RNAIavgCellDep) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=totalAvgRNAiCell, linetype="dashed", color = "blue") + 
    labs(y = "Average dependency score per cell line", x = "Cell Lines") + 
    ggtitle("Average RNAI dependency scores for all cell lines") 
```

Plot of average CRISPR dependency scores for all genes

```{r, eval=FALSE, echo=T}
#Plot of avg RNAI dep scores for all genes
ggplot(compGeneMeans) + aes(ID, CRISPRavgGeneDep, color = CRISPRavgGeneDep) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=totalAvgCrisprGene, linetype="dashed", color = "blue") + 
    labs(y = "Average dependency score per gene", x = "Genes") + 
    ggtitle("Average CRISPR dependency scores for all genes") 
```

Plot of avg RNAI dep scores for all genes

```{r, eval=FALSE, echo=T}
#Plot of avg RNAI dep scores for all cell lines
ggplot(compGeneMeans) + aes(ID, RNAIavgGeneDep, color = RNAIavgGeneDep) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=totalAvgRNAiGene, linetype="dashed", color = "blue") + 
    labs(y = "Dependency Score", x = "Genes") + 
    ggtitle("Average RNAi dependency scores for all genes") 
```


Plot CRISPR vs RNAi average gene dependency levels all cell lines

```{r, eval=FALSE, echo=T}
#plot CRISPR vs RNAi average gene dependency levels all genes
p2 <- ggplot(compGeneMeans) + aes(CRISPRavgGeneDep, RNAIavgGeneDep, color = CRISPRavgGeneDep) + 
    geom_point() +  scale_colour_viridis() + geom_smooth(method='lm',formula=y~x) +
    labs(y = "RNAIavgGeneDep", x = "CRISPRavgGeneDep") + 
    ggtitle("CRISPR vs RNAi average gene dependency levels all genes") 
p2 + geom_abline(intercept = 0, slope = 1)
```

Plot CRISPR vs RNAi average gene dependency levels all cells

```{r, eval=FALSE, echo=T}
#plot CRISPR vs RNAi average gene dependency levels all cells
p1 <- ggplot(compCellMeans) + aes(CRISPRavgCellDep, RNAIavgCellDep, color = CRISPRavgCellDep) + 
    geom_point() +  scale_colour_viridis() + geom_smooth(method='lm',formula=y~x) +
    labs(y = "RNAIavgCellDep", x = "CRISPRavgCellDep") + 
    ggtitle("CRISPR vs RNAi average gene dependency levels all cell lines") 
p1 + geom_abline(intercept = 0, slope = 1)
```

Average Dependency Scores for RNAi and CRISPR for all genes

```{r, eval=FALSE, echo=T}
#overlay RNAI and CRISPR dependency scores for genes
xyplot(CRISPRavgGeneDep + RNAIavgGeneDep ~ sequence(nrow(compGeneMeans)), data=compGeneMeans, 
       pch = 21, fill = c("blue", "red"), cex = 1, xlab=list("Genes", cex=1.7), 
       ylab=list("Avg Dep Score for each gene", cex=1.5), 
       main=list("Average Dependency Scores for RNAi and CRISPR for all genes", cex=1.1),
       auto.key=list(space = "top", column = 2, title="Knockout Type", cex.title=1),
       panel = function(x, y, ...)
       {panel.xyplot(x, y, ...)  ## First call the default panel function for 'xyplot'
       panel.abline(h = totalAvgCrisprGene, col = 2, lty = 2)
       panel.abline(h = totalAvgRNAiGene, col = 1, lty = 2)
       })
```

Average Dependency Scores for RNAi and CRISPR for all cell lines

```{r, eval=FALSE, echo=T}
#overlay RNAI and CRISPR for genes
xyplot(CRISPRavgCellDep + RNAIavgCellDep ~ sequence(nrow(compCellMeans)), data=compCellMeans, 
       pch = 21, fill = c("blue", "red"), cex = 1, xlab=list("Cell Lines", cex=1.7), 
       ylab=list("Avg Dep Score for each cell line", cex=1.5), 
       main=list("Average Dependency Scores for RNAi and CRISPR for all cell lines", cex=1.1),
       auto.key=list(space = "top", column = 2, title="Knockout Type", cex.title=1),
       panel = function(x, y, ...)
       {panel.xyplot(x, y, ...)  ## First call the default panel function for 'xyplot'
       panel.abline(h = totalAvgCrisprCell, col = 2, lty = 2)
       panel.abline(h = totalAvgRNAiCell, col = 1, lty = 2)
       })
```

(4) explore the dependency scores for genes with high and low expression 

PSMC2 (Rpt1) was the highest-ranked CYCLOPS candidate gene in the original 
depmap analysis and was also significant in the validation data set. PSMC2 is 
part of the 19S regulatory complex of the 26S proteasome, which is responsible 
for catalyzing the unfolding and translocation of substrates into the 20S 
proteasome

Copy Number Note: Find out what the values of copy number are in copyNumber

```{r, eval=TRUE, echo=F}

# apply function to calculate the mean of all of the dependencies for each gene

#nremove columns with characters
CNsub <- copyNumber[3:23300]

copyNumGeneMean <- apply(CNsub, 1, mean, na.rm = TRUE)

copyNumCellMean <- apply(CNsub, 2, mean, na.rm = TRUE)

#coerce into data frame
copyNumGeneMean <- as.data.frame(copyNumGeneMean)
copyNumCellMean <- as.data.frame(copyNumCellMean)

# add sequence number 
copyNumGeneMean <- tibble::rowid_to_column(copyNumGeneMean, "ID")
copyNumCellMean <- tibble::rowid_to_column(copyNumCellMean, "ID")

#add col names to cellMeans to make the variables more clear
colnames(copyNumCellMean, do.NULL = FALSE)
colnames(copyNumCellMean) <- c("ID","copyNumCellMean")

#add col names to cellMeans to make the variables more clear
colnames(copyNumGeneMean, do.NULL = FALSE)
colnames(copyNumGeneMean) <- c("ID","copyNumGeneMean")

#Delete the rows associated with NA.
copyNumGeneMean<-geneMeans[complete.cases(copyNumGeneMean),]
copyNumCellMean<-geneMeans[complete.cases(copyNumCellMean),]

# calculate averages to show in plots

# total average CRISPR Gene dependency for all genes
totalAvgCNGene <- mean(copyNumGeneMean$copyNumGeneMean, na.rm = TRUE)
#totalAvgCrisprGene 

# total average RNAi Gene dependency for all genes
totalAvgCNCell <- mean(copyNumCellMean$copyNumCellMean, na.rm = TRUE)
```

Plot of avg CRISPR dep scores for all Cell Lines

```{r, eval=FALSE, echo=T}
#Plot of avg CRISPR dep scores for all genes
ggplot(compCellMeans) + aes(ID, CRISPRavgCellDep, color = CRISPRavgCellDep) + 
    geom_point() +  scale_colour_viridis() + 
    geom_hline(yintercept=totalAvgCrisprCell, linetype="dashed", color = "blue")
    + labs(y = "Average dependency score per cell line", x = "Cell Lines") + 
    ggtitle("Average CRISPR dependency scores for all Cell Lines") 
```

Scatterplot overlay

```{r, eval=FALSE, echo=T}
#combine two scatterplots in one
ggplot(df) + geom_point(aes(x = x1, y = y1)) + geom_point(aes(x = x2, y = y2)
```

############## TO FIX ############################

Here we will locate the highest scoring gene dependencies among all cell lines 
for the RNAI dataset. These dependencies might make for interesting targets for 
research.

```{r, eval=FALSE, echo=T}
# remove character columns of `rnai` dataset rename to `rnai0Chars`
rnai0Chars <- subset(rnai, select = -c(depmapID, cellLine))

#add row names so that they can be retrieved later
row.names(rnai0Chars) <- rnai$cellLine

# apply function finds lowest value dep. scores for each gene (column)
lowDepScores <- apply(rnai0Chars, 1, function(x) {min(x, na.rm = TRUE)})

# apply function finds (row) of lowest value dep. scores for each gene (column)
lowDepCellLine <- apply(rnai[c(3:17311)], 1, function(x) which.min(x))
lowDepCellLine <- as.data.frame(lowDepCellLine, row.names = FALSE)
colnames(lowDepCellLine, do.NULL = FALSE)
colnames(lowDepCellLine) <- c("cellLine")
View(lowDepCellLine)

lowDepCellLineList <- rnai$depmapID[lowDepCellLine,]

View(lowDepCellLineList[c(1:10)])

# coerce into data frame
lowDepScores <- as.data.frame(lowDepScores)
View(lowDepScores)
#lowDepCellLine <- as.data.frame(lowDepCellLine)

# turn row names into a column
r1 <-rownames(lowDepScores)
lowDepScores$Cell_Line <- r1
r2 <-rownames(lowDepCellLine)
lowDepCellLine$Cell_Line <- r2

# tidy up df, merge on Cell_Line
df3 = merge(lowDepCellLine, lowDepScores, by.x=c("Cell_Line"), by.y=c("Cell_Line"))
colnames(df3, do.NULL = FALSE)
colnames(df3) <- c("Cell_Line", "Gene", "Dependency_Score")

# sort by 10 highest dependencies 
top10 <-df3[order(df3$Dependency_Score, decreasing=F)[1:10],]
top10
```

It might be interesting to locate the highest scoring dependencies among all 
cell lines for the CRISPR dataset as well.

```{r, eval=FALSE, echo=T}
# function that finds highest dependency scores for each gene and cell line

lowDepScoresCRISPR <- apply(crispr[c(2:17635)], 1, function(x) {min(x, na.rm = TRUE)})

lowDepGeneCRISPR <- apply(crispr[c(2:17635)], 1, function(x) {depmin <-which.min(x) crispr$depmapID[depmin]})

# coerce into data frame
lowDepScoresCRISPR <- as.data.frame(lowDepScoresCRISPR)
lowDepGeneCRISPR <- as.data.frame(lowDepGeneCRISPR)

df4<-cbind(lowDepGeneCRISPR, lowDepScoresCRISPR)

colnames(df4, do.NULL = FALSE)
colnames(df4) <- c("Gene","Dependency_Score", "Num")

# sort by 10 highest dependencies 
top10CRISPR <-df4[order(df4$Dependency_Score, decreasing=F)[1:10],]
top10CRISPR
```

The gene with the highest dependency score is UBC (7316). This gene represents a 
ubiquitin gene, ubiquitin C. The encoded protein is a polyubiquitin precursor.  
Ubiquitination has been associated with protein degradation, DNA repair, cell 
cycle regulation, kinase modification, endocytosis, and regulation of other cell 
signaling pathways.

If we look for the highest dependency for the SW1088_CENTRAL_NERVOUS_SYSTEM cell
line, we see indeed that UBC (7316) is the most dependent gene for vitality. 

If perhaps we would like to look at the some of the lowest dependency scores:

```{r, eval=FALSE, echo=T}
# sort by 10 highest dependencies 
low10 <-df3[order(df3$Dependency_Score, decreasing=T)[1:10],]
low10
```

```{r, eval=FALSE, echo=T}
#sort dependencies scores of particular cell line my lowest (most important)
ubc <-rnai[order(rnai$SW1088_CENTRAL_NERVOUS_SYSTEM, decreasing=F)[1:10],]
dep_values_cns <- rbind(ubc$X1, ubc$SW1088_CENTRAL_NERVOUS_SYSTEM)
print("Dependency scores for top 10 dependent genes for SW1088_CENTRAL_NERVOUS_SYSTEM")
dep_values_cns
# [1] "Dependency scores for top 10 dependent genes for SW1088_CENTRAL_NERVOUS_SYSTEM"
#     [,1]             [,2]             [,3]             [,4]             [,5]             [,6]            
# [1,] "UBC (7316)"     "PSMA3 (5684)"   "PSMA4 (5685)"   "UBA52 (7311)"   "COPZ1 (22818)"  "SRSF1 (6426)"  
# [2,] "-5.93237872763" "-3.17473770863" "-2.95412602267" "-2.86619955206" "-2.68313273074" "-2.63257840872"
#     [,7]             [,8]            [,9]             [,10]                           
# [1,] "NACA (4666)"    "MED28 (80306)" "UBB (7314)"     "U2AF1L5&U2AF1 (102724594&7307)"
# [2,] "-2.52727165132" "-2.4743706891" "-2.31711569988" "-2.30982469365"        
```

